<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detection Viewer</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
    }

    header {
      background: #16213e;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #0f3460;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 500;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: #888;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #e94560;
    }

    .status-dot.connected {
      background: #4ecca3;
    }

    .detection-count {
      background: #0f3460;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.85rem;
    }

    main {
      padding: 1.5rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem;
    }

    .detection-card {
      background: #16213e;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .detection-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .detection-card.new {
      animation: highlight 2s ease-out;
    }

    @keyframes highlight {
      0% { box-shadow: 0 0 20px #4ecca3; }
      100% { box-shadow: none; }
    }

    .detection-card img {
      width: 100%;
      aspect-ratio: 10 / 3;
      object-fit: cover;
      display: block;
    }

    .detection-info {
      padding: 0.75rem;
    }

    .vehicle-type {
      font-weight: 600;
      text-transform: capitalize;
      color: #4ecca3;
    }

    .timestamp {
      font-size: 0.8rem;
      color: #888;
      margin-top: 0.25rem;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal-overlay.active {
      display: block;
    }

    .modal-header {
      position: sticky;
      top: 0;
      background: #16213e;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1001;
    }

    .modal-title {
      font-size: 1.25rem;
    }

    .close-btn {
      background: none;
      border: none;
      color: #eee;
      font-size: 2rem;
      cursor: pointer;
      padding: 0 0.5rem;
    }

    .close-btn:hover {
      color: #e94560;
    }

    .modal-content {
      padding: 1.5rem;
    }

    .frames-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }

    .frame-card {
      background: #16213e;
      border-radius: 8px;
      overflow: hidden;
    }

    .frame-card img {
      width: 100%;
      display: block;
    }

    .frame-name {
      padding: 0.5rem;
      text-align: center;
      font-size: 0.85rem;
      color: #888;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #888;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #666;
    }

    .empty-state h2 {
      margin-bottom: 0.5rem;
      color: #888;
    }
  </style>
</head>
<body>
  <header>
    <h1>Detection Viewer</h1>
    <div class="status">
      <span class="status-dot" id="statusDot"></span>
      <span id="statusText">Connecting...</span>
      <span class="detection-count"><span id="detectionCount">0</span> detections</span>
    </div>
  </header>

  <main>
    <div class="grid" id="grid">
      <div class="loading" id="loading">Loading detections...</div>
    </div>
    <div class="empty-state" id="emptyState" style="display: none;">
      <h2>No detections yet</h2>
      <p>New detections will appear here automatically</p>
    </div>
  </main>

  <!-- Modal for viewing all frames -->
  <div class="modal-overlay" id="modal">
    <div class="modal-header">
      <span class="modal-title" id="modalTitle">Detection Frames</span>
      <button class="close-btn" id="closeModal">&times;</button>
    </div>
    <div class="modal-content">
      <div class="frames-grid" id="framesGrid"></div>
    </div>
  </div>

  <script>
    const grid = document.getElementById('grid');
    const loading = document.getElementById('loading');
    const emptyState = document.getElementById('emptyState');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const detectionCount = document.getElementById('detectionCount');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const framesGrid = document.getElementById('framesGrid');
    const closeModal = document.getElementById('closeModal');

    let detections = [];

    // Create a detection card element
    function createDetectionCard(detection, isNew = false) {
      const card = document.createElement('div');
      card.className = 'detection-card' + (isNew ? ' new' : '');
      card.dataset.name = detection.name;

      const thumbnailPath = `/image/${detection.name}_frames/frame_0003.jpg`;

      card.innerHTML = `
        <img src="${thumbnailPath}" alt="${detection.vehicle_type}" loading="lazy">
        <div class="detection-info">
          <div class="vehicle-type">${detection.vehicle_type}</div>
          <div class="timestamp">${detection.display_time}</div>
        </div>
      `;

      card.addEventListener('click', () => openModal(detection));

      return card;
    }

    // Update the grid with detections
    function updateGrid() {
      loading.style.display = 'none';

      if (detections.length === 0) {
        emptyState.style.display = 'block';
        grid.style.display = 'none';
      } else {
        emptyState.style.display = 'none';
        grid.style.display = 'grid';
      }

      detectionCount.textContent = detections.length;
    }

    // Load initial detections
    async function loadDetections() {
      try {
        const response = await fetch('/detections');
        detections = await response.json();

        // Clear and populate grid
        grid.innerHTML = '';
        detections.forEach(d => {
          grid.appendChild(createDetectionCard(d));
        });

        updateGrid();
      } catch (error) {
        console.error('Failed to load detections:', error);
        loading.textContent = 'Failed to load detections';
      }
    }

    // Add a new detection to the grid
    function addDetection(detection) {
      detections.unshift(detection);

      const card = createDetectionCard(detection, true);
      grid.insertBefore(card, grid.firstChild);

      updateGrid();
    }

    // Open modal to show all frames
    async function openModal(detection) {
      modalTitle.textContent = `${detection.vehicle_type} - ${detection.display_time}`;
      framesGrid.innerHTML = '<div class="loading">Loading frames...</div>';
      modal.classList.add('active');

      try {
        const response = await fetch(`/frames/${detection.name}`);
        const frames = await response.json();

        framesGrid.innerHTML = '';
        frames.forEach(frame => {
          const card = document.createElement('div');
          card.className = 'frame-card';
          card.innerHTML = `
            <img src="/image/${frame.path}" alt="${frame.name}" loading="lazy">
            <div class="frame-name">${frame.name}</div>
          `;
          framesGrid.appendChild(card);
        });
      } catch (error) {
        console.error('Failed to load frames:', error);
        framesGrid.innerHTML = '<div class="loading">Failed to load frames</div>';
      }
    }

    // Close modal
    function closeModalHandler() {
      modal.classList.remove('active');
    }

    closeModal.addEventListener('click', closeModalHandler);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModalHandler();
      }
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModalHandler();
      }
    });

    // Connect to SSE for real-time updates
    function connectSSE() {
      const eventSource = new EventSource('/events');

      eventSource.onopen = () => {
        statusDot.classList.add('connected');
        statusText.textContent = 'Connected';
      };

      eventSource.onerror = () => {
        statusDot.classList.remove('connected');
        statusText.textContent = 'Disconnected - reconnecting...';
      };

      eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'new_detection') {
          addDetection(data.detection);
        }
      };
    }

    // Initialize
    loadDetections();
    connectSSE();
  </script>
</body>
</html>
